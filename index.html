<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pay√©Cash ¬∑ Simulateur Caisse Esp√®ces</title>
  <style>
    :root{
      --bg:#0b1020;
      --txt:#e9ecff;
      --muted:#aab2e6;
      --accent:#7cf7d4;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --ok:#4ee07a;
      --line:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(124,247,212,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(138,162,255,.14), transparent 55%),
        var(--bg);
      color:var(--txt);
      min-height:100vh;
      padding-bottom: env(safe-area-inset-bottom);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header{
      padding:18px 18px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    h1 .pill{
      font-size:12px;
      color:var(--bg);
      background:var(--accent);
      padding:5px 10px;
      border-radius:999px;
      font-weight:800;
      white-space:nowrap;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding: 0 18px 22px;
      display:grid;
      grid-template-columns: 1.3fr .9fr;
      gap:16px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
      min-width:0;
    }

    .card .head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }

    .card .head h2{
      margin:0;
      font-size:14px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.25px;
      text-transform:uppercase;
    }

    .card .body{ padding:14px; }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      min-width:0;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }

    .mono{ font-family:var(--mono); }
    .big{
      font-size:30px;
      font-weight:900;
      letter-spacing:.2px;
      word-break: break-word;
    }
    .muted{ color:var(--muted); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      user-select:none;
      white-space:nowrap;
      max-width:100%;
    }

    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:800;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.20); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(124,247,212,.16);
      border-color: rgba(124,247,212,.35);
    }
    .btn.primary:hover{ background: rgba(124,247,212,.22); }
    .btn.danger{ border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10); }
    .btn.small{ padding:8px 10px; border-radius: 10px; font-size:12px; }
    .btn.ghost{ background: transparent; }

    input, select{
      width:100%;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      min-width:0;
      font-size:16px; /* √©vite zoom iOS */
    }
    input:focus, select:focus{
      border-color: rgba(124,247,212,.45);
      box-shadow: 0 0 0 3px rgba(124,247,212,.14);
    }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi .box{
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      min-width:0;
    }
    .kpi .box .t{ font-size:12px; color:var(--muted); }
    .kpi .box .v{ font-size:18px; font-weight:900; margin-top:4px; }

    .list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
    }
    .list li{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.03);
      min-width:0;
    }
    .list li:last-child{ border-bottom:none; }

    .sep{ height:1px; background: var(--line); margin:12px 0; }

    .hint{
      padding:10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(124,247,212,.35);
      background: rgba(124,247,212,.08);
      color: var(--txt);
      font-size:13px;
      line-height:1.35;
      overflow-wrap:anywhere;
    }

    .result{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:13px;
      line-height:1.45;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .good{ border-color: rgba(78,224,122,.35); background: rgba(78,224,122,.08); }
    .bad{ border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.08); }
    .warn{ border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.08); }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip:hover{ background: rgba(255,255,255,.10); }

    .monoSmall{ font-family:var(--mono); font-size:12px; color:var(--muted); }
    .note{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }

    footer{
      max-width:1100px;
      margin: 0 auto;
      padding: 0 18px 24px;
      color: var(--muted);
      font-size: 12px;
    }

    .kbd{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.2);
      color: var(--txt);
      display:inline-block;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns:1fr; }
    }

    @media (max-width: 560px){
      header{ padding:14px 12px 8px; }
      .wrap{ padding: 0 12px 18px; gap:12px; }
      .card .body{ padding:12px; }
      .card .head{ padding:12px 12px 8px; }
      .grid2{ grid-template-columns:1fr; }
      .big{ font-size:26px; }

      /* boutons de la zone "actions" en colonne */
      .actions .btn{ width:100%; justify-content:center; }

      /* les petits boutons (header) restent compacts */
      .btn.small{ width:auto; }
    }

    @media (max-width: 380px){
      .big{ font-size:24px; }
      h1{ font-size:16px; }
      h1 .pill{ font-size:11px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>ü™ô Pay√©Cash <span class="pill">simulateur caisse</span></h1>
    <div class="row">
      <span class="badge">‚è±Ô∏è <span id="timer">00:00</span></span>
      <span class="badge">üéØ S√©rie <span id="streak">0</span></span>
      <span class="badge">üìà Niveau <span id="levelLabel">1</span></span>

      <span class="badge">
        üßë‚Äçüíº Client
        <select id="customerLang" style="width:auto; padding:6px 10px; border-radius:10px; font-size:14px">
          <option value="fr">FR</option>
          <option value="es">ES</option>
        </select>
      </span>

      <button class="btn small ghost" id="resetStats">R√©initialiser stats</button>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="head">
        <h2>Sc√©nario client</h2>
        <div class="row">
          <button class="btn small" id="newCase">Nouveau client</button>
          <button class="btn small" id="toggleDetails">Afficher d√©tails</button>
          <button class="btn small" id="toggleHints">Aide ON</button>
        </div>
      </div>

      <div class="body">
        <div class="grid2">
          <div>
            <div class="muted">Total √† payer</div>
            <div class="big mono" id="totalDisplay">--,-- ‚Ç¨</div>
            <div class="monoSmall" id="caseMeta"></div>
          </div>
          <div>
            <div class="muted">Le client donne</div>
            <div class="big mono" id="paidDisplay">--,-- ‚Ç¨</div>
            <div class="monoSmall" id="paidBreakdown"></div>
          </div>
        </div>

        <div class="sep"></div>

        <div id="detailsBlock" class="result" style="display:none"></div>
        <div id="hintBlock" class="hint" style="display:none"></div>

        <div class="sep"></div>

        <div class="grid2">
          <div>
            <label class="muted">Option: proposer un arrondi (√† l‚Äôeuro sup√©rieur)</label>
            <select id="roundingMode">
              <option value="off">D√©sactiv√©</option>
              <option value="suggest">Je propose (texte)</option>
              <option value="must">Obligatoire (le jeu te note)</option>
            </select>

            <div style="margin-top:10px" class="chips" id="quickPhrases" aria-label="phrases rapides"></div>
            <div class="note">Mode ES: phrases rapides en espagnol (clic = pr√©-remplit le montant √† demander pour arrondir).</div>
          </div>

          <div>
            <label class="muted">Ta r√©ponse: monnaie √† rendre (‚Ç¨)</label>
            <input id="answerInput" inputmode="decimal" placeholder="Ex: 18,25" />

            <div class="row actions" style="margin-top:10px">
              <button class="btn primary" id="check">Valider</button>
              <button class="btn" id="showSolution">Voir correction</button>
              <button class="btn danger" id="panic">Je panique üòµ</button>
            </div>

            <div style="margin-top:10px">
              <label class="muted">Optionnel: ce que tu demandes au client pour arrondir (‚Ç¨)</label>
              <input id="askInput" inputmode="decimal" placeholder="Ex: 0,25 (si tu proposes un arrondi)" />
              <div class="note">Astuce: annonce toujours les 2: ‚ÄúSi vous avez X, je vous rends Y tout rond.‚Äù</div>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div id="feedback" class="result" style="display:none"></div>
      </div>
    </section>

    <aside class="card">
      <div class="head">
        <h2>Progression</h2>
        <div class="row">
          <button class="btn small" id="levelDown">‚àí</button>
          <button class="btn small" id="levelUp">+</button>
        </div>
      </div>

      <div class="body">
        <div class="kpi">
          <div class="box">
            <div class="t">‚úÖ Justesse</div>
            <div class="v" id="acc">0%</div>
          </div>
          <div class="box">
            <div class="t">‚ö° Temps moyen</div>
            <div class="v" id="avgTime">--</div>
          </div>
          <div class="box">
            <div class="t">üì¶ Cas r√©solus</div>
            <div class="v" id="solved">0</div>
          </div>
          <div class="box">
            <div class="t">üß© Erreurs</div>
            <div class="v" id="mistakes">0</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="hint">
          <div style="font-weight:900;margin-bottom:6px">R√©flexe ‚Äúcompl√©ter‚Äù (anti-retournage de cerveau)</div>
          <div>Tu pars du <b>total</b> et tu montes vers le <b>pay√©</b> en marches:</div>
          <ul style="margin:8px 0 0; padding-left:18px">
            <li>centimes ‚Üí <b>‚Ä¶ ,00</b></li>
            <li>puis paliers: <b>+1</b>, <b>+2</b>, <b>+5</b>, <b>+10</b>, <b>+20</b></li>
          </ul>
          <div style="margin-top:8px">Raccourcis vers l‚Äôeuro rond:</div>
          <div class="monoSmall">‚Ä¶ ,75‚Üí+0,25 ¬∑ ‚Ä¶ ,80‚Üí+0,20 ¬∑ ‚Ä¶ ,90‚Üí+0,10 ¬∑ ‚Ä¶ ,95‚Üí+0,05 ¬∑ ‚Ä¶ ,98‚Üí+0,02 ¬∑ ‚Ä¶ ,99‚Üí+0,01</div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div class="muted">Historique (10 derniers)</div>
          <button class="btn small" id="exportStats">Exporter JSON</button>
        </div>

        <ul class="list" id="history"></ul>

        <div class="sep"></div>

        <div class="muted">Raccourcis clavier</div>
        <div class="monoSmall" style="margin-top:6px">
          <span class="kbd">Entr√©e</span> valider ¬∑ <span class="kbd">N</span> nouveau client ¬∑ <span class="kbd">H</span> aide
        </div>
      </div>
    </aside>
  </div>

  <footer>
    Con√ßu pour GitHub Pages: un seul fichier, stockage local (localStorage). Aucun serveur, aucune donn√©e envoy√©e.
  </footer>

<script>
(() => {
  // ---------- Utils ----------
  const euroText = (cents) => (cents/100).toFixed(2).replace('.', ',') + ' ‚Ç¨';
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const now = () => Date.now();
  const el = (id)=>document.getElementById(id);
  const langNow = () => document.getElementById('customerLang')?.value || 'fr';

  function parseEurosToCents(str){
    if(!str) return null;
    const s = str.trim().replace(/\s/g,'').replace(',', '.');
    if(!s) return null;
    if(!/^\d+(\.\d{1,2})?$/.test(s)) return null;
    const parts = s.split('.');
    const euros = parseInt(parts[0],10);
    const cents = parts[1] ? (parts[1].padEnd(2,'0').slice(0,2)) : '00';
    return euros*100 + parseInt(cents,10);
  }

  function formatAskPhraseFR(askCents, changeRoundedCents){
    const ask = (askCents/100).toFixed(2).replace('.', ',');
    const chg = Math.floor(changeRoundedCents/100).toString();
    return `‚ÄúSi vous avez ${ask} ‚Ç¨, √ßa m‚Äôarrange, je vous rends ${chg} ‚Ç¨ tout rond.‚Äù`;
  }

  // ---------- Phrasebook (FR/ES) ----------
  const PHRASES = {
    fr: {
      greet: "Bonjour üôÇ",
      pay: "Je paie en esp√®ces.",
      roundingAsk: (x) => `Vous auriez ${x} ‚Ç¨ ? Comme √ßa je vous rends tout rond.`,
      roundingAsk2: (x,y) => `Si vous avez ${x} ‚Ç¨, √ßa m‚Äôarrange, je vous rends ${y} ‚Ç¨ tout rond.`,
      exact: (chg) => `Parfait, je vous rends ${chg} ‚Ç¨.`,
      thanks: "Merci, bonne journ√©e !"
    },
    es: {
      greet: "Hola üôÇ",
      pay: "Pago en efectivo.",
      roundingAsk: (x) => `¬øTienes ${x} ‚Ç¨? As√≠ te devuelvo redondo.`,
      roundingAsk2: (x,y) => `Si tienes ${x} ‚Ç¨, mejor, as√≠ te devuelvo ${y} ‚Ç¨ justo.`,
      exact: (chg) => `Perfecto, te devuelvo ${chg} ‚Ç¨.`,
      thanks: "¬°Gracias, buen d√≠a!"
    }
  };

  // ---------- Money system ----------
  const COINS = [200,100,50,20,10,5,2,1];
  const BILLS = [50000,20000,10000,5000,2000,1000,500];
  const DENOMS = [...BILLS, ...COINS];

  function makeChangeBreakdown(amountCents){
    let rest = amountCents;
    const out = [];
    for(const d of DENOMS){
      if(rest <= 0) break;
      const k = Math.floor(rest / d);
      if(k>0){
        out.push([d,k]);
        rest -= d*k;
      }
    }
    return out;
  }

  function breakdownToString(bd){
    if(!bd || !bd.length) return '0';
    return bd.map(([d,k]) => {
      if(d>=100) return `${k}√ó${(d/100).toFixed(0)}‚Ç¨`;
      return `${k}√ó${d}c`;
    }).join(' + ');
  }

  function denomListToString(list){
    if(!list || !list.length) return '0';
    const counts = new Map();
    for(const d of list) counts.set(d, (counts.get(d)||0)+1);
    const ordered = Array.from(counts.entries()).sort((a,b)=>b[0]-a[0]);
    return ordered.map(([d,k]) => d>=100 ? `${k}√ó${(d/100).toFixed(0)}‚Ç¨` : `${k}√ó${d}c`).join(' + ');
  }

  function countingUpSteps(totalCents, paidCents){
    let cur = totalCents;
    const steps = [];
    const pushStep = (to) => {
      if(to>cur){
        steps.push({from: cur, to, add: to-cur});
        cur = to;
      }
    };

    const mod = cur % 100;
    if(mod !== 0) pushStep(cur + (100 - mod));

    const niceEuroTargets = [5,10,20,50,100,200,500];
    while(cur < paidCents){
      const curEuro = Math.floor(cur/100);
      const candidates = [];
      candidates.push((curEuro+1)*100);
      for(const t of niceEuroTargets){
        const next = (Math.floor(curEuro / t) + 1)*t*100;
        candidates.push(next);
      }
      let best = null;
      for(const c of candidates){
        if(c<=paidCents && c>cur) best = best===null ? c : Math.max(best, c);
      }
      if(best===null) best = paidCents;
      pushStep(best);
      if(best===paidCents) break;
    }
    return steps;
  }

  // ---------- State / Stats ----------
  const DEFAULTS = { level: 1, showHints: true, showDetails: false };

  const state = {
    level: DEFAULTS.level,
    showHints: DEFAULTS.showHints,
    showDetails: DEFAULTS.showDetails,
    case: null,
    startTime: null,
    timerInt: null,
    stats: null
  };

  const LS_KEY = 'cashsim_stats_v1';

  function loadStats(){
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      try { return JSON.parse(raw); } catch(e){}
    }
    return { solved:0, correct:0, mistakes:0, streak:0, bestStreak:0, timesMs:[], history:[] };
  }

  function saveStats(){
    localStorage.setItem(LS_KEY, JSON.stringify(state.stats));
  }

  function levelConfig(level){
    return {
      level,
      maxItems: clamp(2 + level, 3, 9),
      allow1c2c: level >= 3,
      allowMixedPay: level >= 2,
      allowBigBills: level >= 4,
      maxTotalCents: [2000, 3500, 6000, 12000, 20000][clamp(level-1,0,4)]
    };
  }

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // ---------- Scenario generation ----------
  function generateBasket(cfg){
    const items = [];
    const n = randInt(2, cfg.maxItems);

    const namesWeight = {
      fr: ['Fromage','Jambon','Olives','Amandes','Fruits secs','Saucisson','Bonbons','Th√©','Caf√©','Tomates'],
      es: ['Queso','Jam√≥n','Aceitunas','Almendras','Frutos secos','Fuet','Caramelos','T√©','Caf√©','Tomates']
    };
    const namesUnit = {
      fr: ['Confiture','Miel','Biscuit','Soda','Pain','Chocolat','Savon','P√¢t√©','Terrine','Jus'],
      es: ['Mermelada','Miel','Galletas','Refresco','Pan','Chocolate','Jab√≥n','Pat√©','Terrina','Zumo']
    };

    const lang = langNow();

    for(let i=0;i<n;i++){
      const type = Math.random() < 0.55 ? 'weight' : 'unit';
      if(type==='weight'){
        const pricePerKgC = randInt(790, 3990);
        const grams = randInt(80, 650);
        const amountC = Math.round(pricePerKgC * grams / 1000);
        const name = pick(namesWeight[lang] || namesWeight.fr);
        items.push({ name, type, pricePerKgC, grams, amountC });
      } else {
        const priceC = randInt(120, 1290);
        const qty = randInt(1, (cfg.level>=4 ? 3 : 2));
        const amountC = priceC*qty;
        const name = pick(namesUnit[lang] || namesUnit.fr);
        items.push({ name, type, priceC, qty, amountC });
      }
    }

    let total = items.reduce((s,it)=>s+it.amountC,0);

    if(cfg.level === 1){
      const endings = [0,10,20,50,70,80,90];
      const want = pick(endings);
      total = total - (total%100) + want;
    } else if(cfg.level === 2){
      const endings = [0,5,10,15,20,25,30,40,50,60,70,75,80,90,95];
      const want = pick(endings);
      total = total - (total%100) + want;
    } else {
      if(!cfg.allow1c2c){
        const c = total % 100;
        if(c===1) total += 4;
        if(c===2) total += 3;
        if(c===3) total += 2;
        if(c===4) total += 1;
        if(c===6) total += 4;
        if(c===7) total += 3;
        if(c===8) total += 2;
        if(c===9) total += 1;
      }
    }

    if(total > cfg.maxTotalCents){
      const factor = cfg.maxTotalCents / total;
      total = Math.max(100, Math.floor(total * factor));
      total = total - (total%5);
    }

    return { items, totalCents: total };
  }

  function generatePayment(totalCents, cfg){
    const choices = [];
    if(cfg.level>=2 && Math.random()<0.18) choices.push(totalCents);

    const totalEuro = Math.floor((totalCents + 99)/100);
    choices.push(totalEuro*100);

    const steps = [500,1000,2000,5000,10000];
    for(const s of steps){
      const paid = Math.ceil(totalCents / s) * s;
      choices.push(paid);
    }

    if(cfg.allowBigBills){
      choices.push(10000);
      choices.push(20000);
    }

    let paidCents = pick(choices.filter(x=>x>=totalCents));

    if(cfg.level<=2){
      paidCents = Math.min(paidCents, totalCents + 5000);
      if(paidCents < totalCents) paidCents = totalCents;
    }

    let breakdown = null;
    if(cfg.allowMixedPay && Math.random()<0.55){
      let rest = paidCents;
      breakdown = [];
      const n = randInt(2, cfg.level>=4 ? 5 : 4);

      for(let i=0;i<n-1;i++){
        const avail = DENOMS.filter(d => d<=rest);
        const d = pick(avail);
        breakdown.push(d);
        rest -= d;
        if(rest<=0) break;
      }
      if(rest>0) breakdown.push(rest);

      const last = breakdown[breakdown.length-1];
      if(!DENOMS.includes(last)){
        breakdown.pop();
        const extra = makeChangeBreakdown(last).flatMap(([d,k]) => Array(k).fill(d));
        breakdown.push(...extra);
      }

      breakdown.sort(()=>Math.random()-0.5);
    } else {
      breakdown = [paidCents];
    }

    return { paidCents, breakdown };
  }

  function basketToText(basket){
    const lang = langNow();
    const lines = basket.items.map(it => {
      if(it.type==='weight'){
        const p = (it.pricePerKgC/100).toFixed(2).replace('.', ',');
        return lang === 'es'
          ? `‚Ä¢ ${it.name} (${it.grams} g a ${p} ‚Ç¨/kg) = ${euroText(it.amountC)}`
          : `‚Ä¢ ${it.name} (${it.grams} g √† ${p} ‚Ç¨/kg) = ${euroText(it.amountC)}`;
      }
      const p = (it.priceC/100).toFixed(2).replace('.', ',');
      return `‚Ä¢ ${it.name} (${it.qty} √ó ${p} ‚Ç¨) = ${euroText(it.amountC)}`;
    });
    lines.push(`\nTOTAL = ${euroText(basket.totalCents)}`);
    return lines.join('\n');
  }

  // ---------- UI ----------
  function setFeedback(obj){
    const fb = el('feedback');
    if(!obj){
      fb.style.display='none';
      fb.textContent='';
      fb.className='result';
      return;
    }
    fb.style.display='block';
    fb.textContent = obj.text;
    fb.className = 'result ' + (obj.kind||'');
  }

  function renderStats(){
    const s = state.stats;
    el('solved').textContent = String(s.solved);
    el('mistakes').textContent = String(s.mistakes);
    el('streak').textContent = String(s.streak);

    const acc = s.solved ? Math.round((s.correct/s.solved)*100) : 0;
    el('acc').textContent = `${acc}%`;

    const times = s.timesMs;
    if(times.length){
      const avg = Math.round(times.reduce((a,b)=>a+b,0)/times.length);
      el('avgTime').textContent = `${(avg/1000).toFixed(1)}s`;
    } else {
      el('avgTime').textContent = '--';
    }

    const ul = el('history');
    ul.innerHTML = '';
    for(const h of s.history.slice(0,10)){
      const li = document.createElement('li');
      const left = document.createElement('div');
      left.innerHTML = `<div class="mono">${h.total} ‚Üí ${h.paid}</div><div class="monoSmall">${h.note}</div>`;
      const right = document.createElement('div');
      right.className = 'mono';
      right.textContent = h.ok ? '‚úÖ' : '‚ùå';
      li.appendChild(left);
      li.appendChild(right);
      ul.appendChild(li);
    }
  }

  function renderCase(){
    const c = state.case;

    el('totalDisplay').textContent = euroText(c.basket.totalCents);
    el('paidDisplay').textContent = euroText(c.pay.paidCents);

    const cfg = levelConfig(state.level);
    const lang = langNow();
    el('caseMeta').textContent =
      `Mode niveau ${cfg.level} ¬∑ ${c.basket.items.length} article(s)` + (lang === 'es' ? ' ¬∑ Client ES üá™üá∏' : ' ¬∑ Client FR üá´üá∑');

    // ici on affiche le vrai "combo client" s'il existe
    el('paidBreakdown').textContent = `D√©tail: ${denomListToString(c.pay.breakdown)}`;

    const d = el('detailsBlock');
    d.textContent = basketToText(c.basket);
    d.style.display = state.showDetails ? 'block' : 'none';

    const h = el('hintBlock');
    const stepLines = c.steps.map(s => `- ${euroText(s.from)} ‚Üí ${euroText(s.to)} : +${euroText(s.add)}`).join('\n');
    const chg = makeChangeBreakdown(c.changeCents);
    h.innerHTML = `
      <div style="font-weight:900;margin-bottom:6px">Aide ‚Äúcompl√©ter jusqu‚Äô√†‚Äù</div>
      <div class="monoSmall" style="margin-bottom:8px">${stepLines || '(exact, rien √† rendre)'}</div>
      <div style="margin-top:6px"><b>Monnaie totale:</b> ${euroText(c.changeCents)} ¬∑ <span class="monoSmall">Suggestion: ${breakdownToString(chg)}</span></div>
      <div style="margin-top:8px"><b>Arrondi (option):</b> vers ${euroText(c.nextEuro)} ‚Üí demander ${euroText(c.askCents)} ¬∑ puis rendre ${Math.floor(c.roundedChangeCents/100)} ‚Ç¨</div>
    `;
    h.style.display = state.showHints ? 'block' : 'none';

    // quick phrases chips (FR/ES)
    const L = PHRASES[lang] || PHRASES.fr;
    const qp = el('quickPhrases');
    qp.innerHTML = '';

    const ask = c.askCents;
    const roundedChange = c.roundedChangeCents;
    const x = (ask/100).toFixed(2).replace('.', ',');
    const y = Math.floor(roundedChange/100).toString();

    const chips = [];
    chips.push(`${L.greet} ¬∑ ${L.pay}`);

    if(ask > 0){
      chips.push(L.roundingAsk(x));
      chips.push(L.roundingAsk2(x, y));
    } else {
      const chgTxt = (c.changeCents/100).toFixed(2).replace('.', ',');
      chips.push(L.exact(chgTxt));
    }
    chips.push(L.thanks);

    for(const t of chips){
      const div = document.createElement('div');
      div.className='chip';
      div.textContent = t;
      div.title = 'Clique pour pr√©-remplir le montant √† demander (arrondi)';
      div.addEventListener('click', () => {
        if(ask>0) el('askInput').value = x;
      });
      qp.appendChild(div);
    }

    el('levelLabel').textContent = String(state.level);
    el('toggleDetails').textContent = state.showDetails ? 'Masquer d√©tails' : 'Afficher d√©tails';
    el('toggleHints').textContent = state.showHints ? 'Aide ON' : 'Aide OFF';

    renderStats();
  }

  // ---------- New case ----------
  function newCase(){
    const cfg = levelConfig(state.level);
    const basket = generateBasket(cfg);
    const pay = generatePayment(basket.totalCents, cfg);

    const steps = countingUpSteps(basket.totalCents, pay.paidCents);
    const changeCents = pay.paidCents - basket.totalCents;

    const nextEuro = Math.ceil(basket.totalCents/100)*100;
    const askCents = nextEuro - basket.totalCents;
    const roundedChangeCents = pay.paidCents - nextEuro;

    state.case = {
      basket,
      pay,
      changeCents,
      steps,
      nextEuro,
      askCents,
      roundedChangeCents,
      createdAt: now()
    };
    state.startTime = now();

    el('answerInput').value = '';
    el('askInput').value = '';
    setFeedback(null);
    renderCase();

    // focus sans scroll violent
    try { el('answerInput').focus({preventScroll:true}); } catch { el('answerInput').focus(); }
  }

  // ---------- Validation ----------
  function checkAnswer({showCorrection=false, panic=false} = {}){
    const c = state.case;
    const roundingMode = el('roundingMode').value;

    const ansCents = parseEurosToCents(el('answerInput').value);
    const askCentsInput = parseEurosToCents(el('askInput').value);

    if(ansCents===null){
      setFeedback({kind:'warn', text:'Entre une monnaie √† rendre valide (ex: 18,25).'});
      return;
    }

    const canRound = c.askCents>0 && c.nextEuro<=c.pay.paidCents;
    let expectedChange = c.changeCents;
    let expectedAsk = null;

    if(roundingMode==='off'){
      expectedChange = c.changeCents;
    } else {
      const userProposes = askCentsInput!==null && askCentsInput>0;
      const shouldPropose = roundingMode==='must';

      if(userProposes){
        expectedAsk = c.askCents;
        expectedChange = c.roundedChangeCents;
      } else if(shouldPropose && canRound){
        expectedAsk = c.askCents;
        expectedChange = c.roundedChangeCents;
      } else {
        expectedChange = c.changeCents;
      }
    }

    const okChange = ansCents === expectedChange;
    let okAsk = true;

    if(expectedAsk!==null){
      okAsk = (askCentsInput === expectedAsk);
    } else if(roundingMode==='must' && canRound){
      okAsk = false;
    }

    const ok = okChange && okAsk;
    const t = now() - state.startTime;

    if(showCorrection || panic){
      const steps = c.steps.map(s=>`‚Ä¢ ${euroText(s.from)} ‚Üí ${euroText(s.to)} : +${euroText(s.add)}`).join('\n');
      const changeBreak = breakdownToString(makeChangeBreakdown(c.changeCents));
      const roundedBreak = breakdownToString(makeChangeBreakdown(c.roundedChangeCents));
      const corrLines = [];
      corrLines.push(`Correction (m√©thode ‚Äúcompl√©ter‚Äù):`);
      corrLines.push(steps || '‚Ä¢ Exact: rien √† rendre');
      corrLines.push(`\nMonnaie √† rendre (sans arrondi): ${euroText(c.changeCents)} (${changeBreak})`);
      if(c.askCents>0 && c.nextEuro<=c.pay.paidCents){
        corrLines.push(`Arrondi possible: demander ${euroText(c.askCents)} pour arriver √† ${euroText(c.nextEuro)}.`);
        corrLines.push(`Puis rendre ${Math.floor(c.roundedChangeCents/100)} ‚Ç¨ (soit ${euroText(c.roundedChangeCents)} ; ${roundedBreak}).`);
        corrLines.push(`Phrase type: ${formatAskPhraseFR(c.askCents, c.roundedChangeCents)}`);
      } else {
        corrLines.push(`Arrondi: inutile/impossible sur ce cas.`);
      }
      setFeedback({kind: panic ? 'warn' : 'good', text: corrLines.join('\n')});
      return;
    }

    state.stats.solved += 1;
    if(ok){
      state.stats.correct += 1;
      state.stats.streak += 1;
      state.stats.bestStreak = Math.max(state.stats.bestStreak, state.stats.streak);
      state.stats.timesMs.push(t);
    } else {
      state.stats.mistakes += 1;
      state.stats.streak = 0;
    }

    const noteParts = [];
    if(roundingMode!=='off'){
      noteParts.push(canRound
        ? `Arrondi: demander ${euroText(c.askCents)} ‚Üí rendre ${Math.floor(c.roundedChangeCents/100)}‚Ç¨`
        : 'Arrondi: non pertinent');
    }
    noteParts.push(`Attendu: ${euroText(expectedChange)}`);
    if(expectedAsk!==null) noteParts.push(`Ask: ${euroText(expectedAsk)}`);

    state.stats.history.unshift({
      ts: new Date().toISOString(),
      total: euroText(c.basket.totalCents),
      paid: euroText(c.pay.paidCents),
      ok,
      note: noteParts.join(' ¬∑ ')
    });
    state.stats.history = state.stats.history.slice(0, 100);

    saveStats();
    renderStats();

    if(ok){
      setFeedback({kind:'good', text:`‚úÖ Juste. Temps: ${(t/1000).toFixed(1)}s\nProchain client pr√™t.`});
      setTimeout(newCase, 350);
    } else {
      let msg = `‚ùå Pas bon.\n`;
      if(!okAsk){
        msg += `Arrondi: attendu ‚Äúdemander ${euroText(c.askCents)}‚Äù (et rendre ${Math.floor(c.roundedChangeCents/100)} ‚Ç¨).\n`;
      }
      msg += `Attendu: ${euroText(expectedChange)}.\n`;
      msg += `Clique ‚ÄúVoir correction‚Äù pour la marche ‚Äúcompl√©ter‚Äù.`;
      setFeedback({kind:'bad', text: msg});
    }
  }

  // ---------- Timer ----------
  function startTimer(){
    if(state.timerInt) clearInterval(state.timerInt);
    const tick = () => {
      if(!state.startTime) return;
      const ms = now() - state.startTime;
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const ss = (s%60).toString().padStart(2,'0');
      el('timer').textContent = `${m.toString().padStart(2,'0')}:${ss}`;
    };
    tick();
    state.timerInt = setInterval(tick, 250);
  }

  // ---------- Events ----------
  function bind(){
    el('newCase').addEventListener('click', newCase);
    el('check').addEventListener('click', () => checkAnswer());
    el('showSolution').addEventListener('click', () => checkAnswer({showCorrection:true}));
    el('panic').addEventListener('click', () => checkAnswer({panic:true}));

    el('toggleHints').addEventListener('click', () => {
      state.showHints = !state.showHints;
      renderCase();
    });

    el('toggleDetails').addEventListener('click', () => {
      state.showDetails = !state.showDetails;
      renderCase();
    });

    el('levelUp').addEventListener('click', () => {
      state.level = clamp(state.level+1, 1, 5);
      newCase();
    });

    el('levelDown').addEventListener('click', () => {
      state.level = clamp(state.level-1, 1, 5);
      newCase();
    });

    el('resetStats').addEventListener('click', () => {
      if(confirm('R√©initialiser les statistiques locales ?')){
        localStorage.removeItem(LS_KEY);
        state.stats = loadStats();
        renderStats();
        setFeedback({kind:'warn', text:'Stats r√©initialis√©es.'});
      }
    });

    el('exportStats').addEventListener('click', async () => {
      const data = JSON.stringify({level: state.level, stats: state.stats}, null, 2);
      try{
        await navigator.clipboard.writeText(data);
        setFeedback({kind:'good', text:'Stats copi√©es dans le presse-papiers (JSON).'});
      } catch(e){
        setFeedback({kind:'warn', text:'Copie auto impossible. (Regarde la console)'}); 
        console.log(data);
      }
    });

    el('customerLang').addEventListener('change', () => newCase());

    window.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        const tag = (document.activeElement?.tagName || '').toLowerCase();
        if(tag !== 'select') checkAnswer();
      }
      if(e.key.toLowerCase() === 'n') newCase();
      if(e.key.toLowerCase() === 'h'){
        state.showHints = !state.showHints;
        renderCase();
      }
    });
  }

  // ---------- Boot ----------
  function boot(){
    state.stats = loadStats();
    bind();
    startTimer();
    newCase();
  }

  boot();
})();
</script>
</body>
</html>
