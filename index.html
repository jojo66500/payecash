<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pay√©Cash ¬∑ Caisse R√©aliste (Catalogue + Caisse simple)</title>
  <style>
    :root{
      --bg:#0b1020;
      --txt:#e9ecff;
      --muted:#aab2e6;
      --accent:#7cf7d4;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --ok:#4ee07a;
      --line:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1100px 700px at 20% 10%, rgba(124,247,212,.14), transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, rgba(138,162,255,.14), transparent 55%),
                  var(--bg);
      color:var(--txt);
      min-height:100vh;
    }
    header{
      padding:18px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    h1 .pill{
      font-size:12px;
      color:var(--bg);
      background:var(--accent);
      padding:5px 10px;
      border-radius:999px;
      font-weight:950;
    }
    .wrap{
      max-width:1220px;
      margin:0 auto;
      padding: 0 18px 22px;
      display:grid;
      grid-template-columns: 1.42fr .78fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .card .head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .head h2{
      margin:0;
      font-size:14px;
      color:var(--muted);
      font-weight:980;
      letter-spacing:.25px;
      text-transform:uppercase;
    }
    .card .body{ padding:14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .mono{ font-family:var(--mono); }
    .muted{ color:var(--muted); }
    .big{
      font-size:30px;
      font-weight:980;
      letter-spacing:.2px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:950;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.20); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(124,247,212,.16);
      border-color: rgba(124,247,212,.35);
    }
    .btn.primary:hover{ background: rgba(124,247,212,.22); }
    .btn.danger{ border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10); }
    .btn.small{ padding:8px 10px; border-radius: 10px; font-size:12px; }
    .btn.ghost{ background: transparent; }

    input, select{
      width:100%;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(124,247,212,.45);
      box-shadow: 0 0 0 3px rgba(124,247,212,.14);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 600px){ .grid2{grid-template-columns:1fr} }
    .sep{ height:1px; background: var(--line); margin:12px 0; }

    .hint, .result{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:13px;
      line-height:1.45;
      white-space: pre-wrap;
    }
    .hint{
      border:1px dashed rgba(124,247,212,.35);
      background: rgba(124,247,212,.08);
    }
    .good{ border-color: rgba(78,224,122,.35); background: rgba(78,224,122,.08); }
    .bad{ border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.08); }
    .warn{ border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.08); }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi .box{
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .kpi .box .t{ font-size:12px; color:var(--muted); }
    .kpi .box .v{ font-size:18px; font-weight:980; margin-top:4px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      cursor:pointer;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:950;
      font-size:12px;
      user-select:none;
    }
    .tab.active{
      color: var(--bg);
      background: var(--accent);
      border-color: rgba(124,247,212,.55);
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
      font-size:13px;
    }
    th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.15px;
      text-transform:uppercase;
      font-weight:980;
      background: rgba(255,255,255,.03);
    }
    tr:last-child td{ border-bottom:none; }
    .cell-mini{ width:140px; }
    .cell-mid{ width:190px; }
    .cell-actions{ width:92px; text-align:right; }

    .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      margin-top:6px;
    }
    footer{
      max-width:1220px;
      margin:0 auto;
      padding: 0 18px 24px;
      color: var(--muted);
      font-size: 12px;
    }
    .kbd{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.2);
      color: var(--txt);
    }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background: rgba(255,255,255,.10); }
    .monoSmall{ font-family:var(--mono); font-size:12px; color:var(--muted); }

    .checklist label{ display:flex; gap:10px; align-items:flex-start; padding:8px 10px; border:1px solid var(--line); border-radius:14px; background: rgba(255,255,255,.04); }
    .checklist input[type="checkbox"]{ margin-top:3px; }

    .subtabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  </style>
</head>

<body>
<header>
  <h1>ü™ô Pay√©Cash <span class="pill">catalogue + caisse simple</span></h1>
  <div class="row">
    <span class="badge">‚è±Ô∏è <span id="timer">00:00</span></span>
    <span class="badge">üéØ S√©rie <span id="streak">0</span></span>
    <span class="badge">üìà Niveau <span id="levelLabel">3</span></span>

    <span class="badge">
      üßë‚Äçüíº Client
      <select id="customerLang" style="width:auto; padding:6px 10px; border-radius:10px">
        <option value="fr">FR</option>
        <option value="es">ES</option>
      </select>
    </span>

    <button class="btn small ghost" id="resetStats">R√©initialiser stats</button>
  </div>
</header>

<div class="wrap">
  <!-- MAIN -->
  <section class="card">
    <div class="head">
      <h2 id="mainTitle">Entra√Ænement r√©aliste</h2>
      <div class="tabs" role="tablist" aria-label="Modes">
        <div class="tab active" id="tabTraining" role="tab" aria-selected="true">Entra√Ænement</div>
        <div class="tab" id="tabTill" role="tab" aria-selected="false">Vraie caisse</div>
        <div class="tab" id="tabChecklist" role="tab" aria-selected="false">Checklist</div>
      </div>
      <div class="row">
        <button class="btn small" id="newCase">Nouveau client</button>
        <button class="btn small" id="toggleDetails">Masquer d√©tails</button>
        <button class="btn small" id="toggleHints">Aide ON</button>
      </div>
    </div>

    <div class="body">

      <!-- TRAINING -->
      <div id="trainingPanel">
        <div class="grid2">
          <div>
            <div class="muted">Total √† payer</div>
            <div class="big mono" id="totalDisplay">--,-- ‚Ç¨</div>
            <div class="monoSmall" id="caseMeta"></div>
          </div>
          <div>
            <div class="muted">Le client donne</div>
            <div class="big mono" id="paidDisplay">--,-- ‚Ç¨</div>
            <div class="monoSmall" id="paidBreakdown"></div>
          </div>
        </div>

        <div class="sep"></div>

        <div id="detailsBlock" class="result" style="display:none"></div>
        <div id="hintBlock" class="hint" style="display:none"></div>

        <div class="sep"></div>

        <div class="grid2">
          <div>
            <label class="muted">Arrondi</label>
            <select id="roundingMode">
              <option value="off">D√©sactiv√©</option>
              <option value="suggest" selected>Je propose (optionnel)</option>
              <option value="must">Obligatoire (not√©)</option>
            </select>

            <div class="sep"></div>

            <div class="muted">Phrases rapides (FR/ES)</div>
            <div style="margin-top:10px" class="chips" id="quickPhrases"></div>
            <div class="note">Clique une phrase: √ßa pr√©-remplit ‚Äúce que tu demandes‚Äù quand c‚Äôest utile.</div>
          </div>

          <div>
            <label class="muted">Ta r√©ponse: monnaie √† rendre (‚Ç¨)</label>
            <input id="answerInput" inputmode="decimal" placeholder="Ex: 18,25" />
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="check">Valider</button>
              <button class="btn" id="showSolution">Voir correction</button>
              <button class="btn danger" id="panic">Je panique üòµ</button>
            </div>

            <div style="margin-top:10px">
              <label class="muted">Optionnel: ce que tu demandes pour arrondir (‚Ç¨)</label>
              <input id="askInput" inputmode="decimal" placeholder="Ex: 0,25" />
              <div class="note">R√©flexe: ‚ÄúSi vous avez X, je vous rends Y.‚Äù</div>
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <div id="feedback" class="result" style="display:none"></div>
      </div>

      <!-- TILL -->
      <div id="tillPanel" style="display:none">

        <div class="grid2">
          <div>
            <div class="muted">Mode Vraie caisse</div>
            <div class="note">Choisis: Catalogue (produits) ou Caisse simple (juste Total + Pay√©).</div>
          </div>
          <div>
            <div class="muted">Sous-mode</div>
            <div class="subtabs">
              <div class="tab active" id="subCatalog" role="tab" aria-selected="true">Catalogue</div>
              <div class="tab" id="subSimple" role="tab" aria-selected="false">Caisse simple</div>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- CATALOG SUBMODE -->
        <div id="catalogSubPanel">
          <div class="grid2">
            <div>
              <div class="muted">Ajout rapide depuis le catalogue (ton magasin)</div>
              <div class="note">Recherche + ajout au poids ou √† l‚Äôunit√©, promos incluses.</div>
            </div>
            <div>
              <div class="muted">Paiement client</div>
              <input id="tillPaidInput" inputmode="decimal" placeholder="Ex: 50,00" />
              <div class="note">Tu peux √©crire avec virgule.</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div>
              <input id="catalogSearch" placeholder="Rechercher (ex: nougat, bi√®re, muscat‚Ä¶)" />
            </div>
            <div class="row" style="justify-content:flex-end">
              <select id="catalogSelect"></select>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px">
            <div>
              <div class="muted">D√©tails produit</div>
              <div class="result" id="catalogInfo" style="min-height:64px"></div>
            </div>
            <div>
              <div class="muted">Quantit√©</div>
              <div class="grid2">
                <input id="catalogQty" inputmode="decimal" placeholder="Qt√© (ex: 1, 2, 3‚Ä¶)" />
                <input id="catalogGrams" inputmode="decimal" placeholder="Grammes (si au poids)" />
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn primary" id="catalogAdd">Ajouter</button>
                <button class="btn" id="applyDeal">Appliquer promo</button>
              </div>
              <div class="note" id="dealHint"></div>
            </div>
          </div>

          <div class="sep"></div>

          <table aria-label="Articles">
            <thead>
              <tr>
                <th>Type</th>
                <th>Libell√©</th>
                <th class="cell-mini">Prix</th>
                <th class="cell-mini">Qt√© / g</th>
                <th class="cell-mid">Total ligne</th>
                <th class="cell-actions">Actions</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>

          <div class="row" style="margin-top:10px; justify-content:space-between">
            <div class="row">
              <button class="btn small" id="addUnit">+ Unit√©</button>
              <button class="btn small" id="addWeight">+ Poids</button>
              <button class="btn small" id="addDirect">+ Montant</button>
              <button class="btn small danger" id="clearItems">Tout effacer</button>
            </div>
            <div class="badge">Total: <span class="mono" id="tillTotal">0,00 ‚Ç¨</span></div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div class="hint">
              <div style="font-weight:980;margin-bottom:6px">R√©sultat caisse</div>
              <div>Total: <span class="mono" id="tillTotal2">0,00 ‚Ç¨</span></div>
              <div>Pay√©: <span class="mono" id="tillPaid2">0,00 ‚Ç¨</span></div>
              <div style="margin-top:6px">Monnaie √† rendre: <span class="mono" id="tillChange">0,00 ‚Ç¨</span></div>
              <div class="note" id="tillWarn" style="margin-top:8px"></div>
              <div class="sep"></div>
              <div class="monoSmall" id="tvaInfo">TVA: 20% uniquement alcool + nougat (aide-m√©moire).</div>
            </div>

            <div class="hint" id="tillSuggestion">
              <div style="font-weight:980;margin-bottom:6px">Suggestion d‚Äôarrondi (anti-pi√®ces)</div>
              <div id="tillSuggestionText" class="monoSmall">Ajoute des articles et un paiement pour voir une proposition.</div>
              <div class="sep"></div>
              <div class="muted">Phrases FR/ES (clic = copie l‚Äôappoint)</div>
              <div style="margin-top:10px" class="chips" id="tillPhrases"></div>
            </div>
          </div>

          <div class="sep"></div>
          <div class="note">
            ‚ÄúPanier compter 2‚Ç¨‚Äù + ‚ÄúEnveloppe du soir: date en haut, SPN au milieu, CA en bas‚Äù (notes patron).
          </div>
        </div>

        <!-- SIMPLE CASHIER SUBMODE -->
        <div id="simpleSubPanel" style="display:none">
          <div class="grid2">
            <div>
              <div class="muted">Total √† encaisser</div>
              <input id="simpleTotalInput" inputmode="decimal" placeholder="Ex: 31,75" />
              <div class="note">Tu peux aussi utiliser ‚ÄúAjouter montant‚Äù pour cumuler des prix.</div>
            </div>
            <div>
              <div class="muted">Pay√© par le client</div>
              <input id="simplePaidInput" inputmode="decimal" placeholder="Ex: 50,00" />
              <div class="note">Billets et pi√®ces, peu importe: tu saisis juste le total donn√©.</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px; justify-content:space-between">
            <div class="row">
              <button class="btn primary" id="simpleCompute">Calculer</button>
              <button class="btn small" id="simpleClear">Effacer</button>
            </div>
            <div class="badge">√Ä rendre: <span class="mono" id="simpleChange">‚Äî</span></div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div class="hint">
              <div style="font-weight:980;margin-bottom:6px">Suggestion d‚Äôarrondi</div>
              <div class="monoSmall" id="simpleSuggestionText">Renseigne Total + Pay√©, puis ‚ÄúCalculer‚Äù.</div>
              <div class="sep"></div>
              <div class="muted">Phrases FR/ES (clic = copie l‚Äôappoint)</div>
              <div style="margin-top:10px" class="chips" id="simplePhrases"></div>
            </div>

            <div class="hint">
              <div style="font-weight:980;margin-bottom:6px">Addition rapide (optionnel)</div>
              <div class="grid2">
                <input id="simpleAddAmount" inputmode="decimal" placeholder="Montant √† ajouter (ex: 6,90)" />
                <button class="btn" id="simpleAddBtn">Ajouter</button>
              </div>
              <div class="note">Pratique si tu tapes des prix ‚Äúau fil de l‚Äôeau‚Äù.</div>
              <div class="sep"></div>
              <div class="result" id="simpleList" style="min-height:84px"></div>
              <div class="row" style="margin-top:10px; justify-content:space-between">
                <button class="btn small danger" id="simpleListClear">Vider la liste</button>
                <div class="badge">Somme: <span class="mono" id="simpleListSum">0,00 ‚Ç¨</span></div>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="note">
            Astuce cerveau: ‚Äúcompl√©ter‚Äù (31,75 ‚Üí 32,00 ‚Üí 40 ‚Üí 50). M√™me quand tu utilises la caisse simple, pense en marches.
          </div>
        </div>

      </div>

      <!-- CHECKLIST -->
      <div id="checklistPanel" style="display:none">
        <div class="hint">
          <div style="font-weight:980;margin-bottom:6px">Checklist (d‚Äôapr√®s les notes de ton patron)</div>
          <div class="note">Tout est local (√ßa se coche et se garde sur ton t√©l√©phone).</div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <div class="checklist" id="checklistOpen">
            <div class="muted" style="margin-bottom:8px">Ouverture / journ√©e</div>
          </div>
          <div class="checklist" id="checklistClose">
            <div class="muted" style="margin-bottom:8px">Fermeture / soir</div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="row">
          <button class="btn small" id="checkAll">Tout cocher</button>
          <button class="btn small danger" id="uncheckAll">Tout d√©cocher</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SIDE -->
  <aside class="card">
    <div class="head">
      <h2>Progression</h2>
      <div class="row">
        <button class="btn small" id="levelDown">‚àí</button>
        <button class="btn small" id="levelUp">+</button>
      </div>
    </div>
    <div class="body">
      <div class="kpi">
        <div class="box">
          <div class="t">‚úÖ Justesse</div>
          <div class="v" id="acc">0%</div>
        </div>
        <div class="box">
          <div class="t">‚ö° Temps moyen</div>
          <div class="v" id="avgTime">--</div>
        </div>
        <div class="box">
          <div class="t">üì¶ Cas r√©solus</div>
          <div class="v" id="solved">0</div>
        </div>
        <div class="box">
          <div class="t">üß© Erreurs</div>
          <div class="v" id="mistakes">0</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="hint">
        <div style="font-weight:980;margin-bottom:6px">M√©thode ‚Äúcompl√©ter‚Äù (ultra fiable)</div>
        <div class="monoSmall">31,75 ‚Üí 32,00 (+0,25) ‚Üí 40,00 (+8) ‚Üí 50,00 (+10)</div>
        <div class="note" style="margin-top:8px">Tu annonces ‚Äúje vous rends‚Ä¶‚Äù et tu donnes billets puis pi√®ces.</div>
      </div>

      <div class="sep"></div>

      <div class="muted">Raccourcis clavier</div>
      <div class="monoSmall" style="margin-top:6px">
        <span class="kbd">Entr√©e</span> valider (training) ¬∑ <span class="kbd">N</span> nouveau client ¬∑ <span class="kbd">H</span> aide
      </div>

      <div class="sep"></div>
      <button class="btn small ghost" id="exportStats">Exporter stats JSON</button>
    </div>
  </aside>
</div>

<footer>
  1 fichier, 0 serveur. Caisse simple = Total + Pay√©, et suggestion d‚Äôappoint pour rendre plus ‚Äúrond‚Äù.
</footer>

<script>
(() => {
  // ---------------- Utilities ----------------
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const now = ()=>Date.now();
  const el = (id)=>document.getElementById(id);

  const euroText = (cents)=> (cents/100).toFixed(2).replace('.', ',') + ' ‚Ç¨';

  function parseEurosToCents(str){
    if(!str) return null;
    const s = str.trim().replace(/\s/g,'').replace(',', '.');
    if(!s) return null;
    if(!/^\d+(\.\d{1,2})?$/.test(s)) return null;
    const parts = s.split('.');
    const euros = parseInt(parts[0],10);
    const cents = parts[1] ? (parts[1].padEnd(2,'0').slice(0,2)) : '00';
    return euros*100 + parseInt(cents,10);
  }

  function centsToInput(cents){
    return (cents/100).toFixed(2).replace('.',',');
  }

  const langNow = ()=> el('customerLang')?.value || 'fr';

  // ---------------- Phrases FR/ES ----------------
  const PHRASES = {
    fr: {
      greet: "Bonjour üôÇ",
      pay: "Je paie en esp√®ces.",
      roundingAsk: (x) => `Vous auriez ${x} ‚Ç¨ ? Comme √ßa je vous rends plus simple.`,
      roundingAsk2: (x,y) => `Si vous avez ${x} ‚Ç¨, je vous rends ${y} ‚Ç¨ tout rond.`,
      exact: (chg) => `Parfait, je vous rends ${chg} ‚Ç¨.`,
      thanks: "Merci, bonne journ√©e !"
    },
    es: {
      greet: "Hola üôÇ",
      pay: "Pago en efectivo.",
      roundingAsk: (x) => `¬øTienes ${x} ‚Ç¨? As√≠ te devuelvo m√°s f√°cil.`,
      roundingAsk2: (x,y) => `Si tienes ${x} ‚Ç¨, te devuelvo ${y} ‚Ç¨ redondo.`,
      exact: (chg) => `Perfecto, te devuelvo ${chg} ‚Ç¨.`,
      thanks: "¬°Gracias, buen d√≠a!"
    }
  };

  // ---------------- Catalogue (d'apr√®s tes notes) ----------------
  const CATALOG = [
    { id:"gateaux_patis", type:"weight", nameFR:"G√¢teaux p√¢tissiers (rousquilles)", nameES:"Pasteles (rosquillas)", pricePerKgC:4000, vat20:false,
      noteFR:"Prix au kilo 40‚Ç¨ (en sachet). Sauf cerise/abricot et rousquillettes: 45‚Ç¨/kg.", noteES:"40‚Ç¨/kg. Excepto cereza/albaricoque y 'rousquillettes': 45‚Ç¨/kg." },
    { id:"gateaux_patis_special", type:"weight", nameFR:"G√¢teaux p√¢tissiers (cerise/abricot/rousquillettes)", nameES:"Pasteles (cereza/albaricoque)", pricePerKgC:4500, vat20:false,
      noteFR:"Exception √† 45‚Ç¨/kg.", noteES:"Excepci√≥n: 45‚Ç¨/kg." },
    { id:"gateau_broche", type:"weight", nameFR:"G√¢teau √† la broche", nameES:"Pastel a la broche", pricePerKgC:4490, vat20:false,
      noteFR:"Prix au kilo 44,90‚Ç¨.", noteES:"44,90‚Ç¨/kg." },

    { id:"nougat", type:"weight", nameFR:"Nougat", nameES:"Turr√≥n (nougat)", pricePerKgC:5900, vat20:true,
      noteFR:"5,90‚Ç¨ les 100g (‚âà59‚Ç¨/kg).", noteES:"5,90‚Ç¨ / 100g (‚âà59‚Ç¨/kg)." },
    { id:"nougat_cube", type:"weight", nameFR:"Nougat petit cube", nameES:"Turr√≥n (cubitos)", pricePerKgC:5900, vat20:true,
      noteFR:"5,90‚Ç¨ les 100g. Cornet 12 (les 2 √† 20‚Ç¨).", noteES:"5,90‚Ç¨/100g. Cono 12: 2 por 20‚Ç¨." },
    { id:"turron", type:"weight", nameFR:"Turron (miel/amande)", nameES:"Turr√≥n (miel/almendra)", pricePerKgC:5900, vat20:true,
      noteFR:"5,90‚Ç¨ les 100g (‚âà59‚Ç¨/kg).", noteES:"5,90‚Ç¨/100g (‚âà59‚Ç¨/kg)." },
    { id:"chocolats", type:"weight", nameFR:"Chocolats (cornet / 100g)", nameES:"Chocolates (100g)", pricePerKgC:5900, vat20:false,
      noteFR:"5,90‚Ç¨ les 100g (‚âà59‚Ç¨/kg). Cornet 12: les 2 √† 20‚Ç¨.", noteES:"5,90‚Ç¨/100g. Cono 12: 2 por 20‚Ç¨." },

    { id:"gateaux_esat", type:"unit", nameFR:"G√¢teaux de l‚ÄôESAT (paquet)", nameES:"Galletas ESAT (paquete)", priceC:690, vat20:false,
      noteFR:"6,90‚Ç¨ le paquet. Offre: les 2 √† 12‚Ç¨ au choix.", noteES:"6,90‚Ç¨ el paquete. Oferta: 2 por 12‚Ç¨.",
      unitDeals:[{buy:2, payCents:1200, noteFR:"2 pour 12‚Ç¨", noteES:"2 por 12‚Ç¨"}]
    },
    { id:"biere_petite", type:"unit", nameFR:"Bi√®re (petite)", nameES:"Cerveza (peque√±a)", priceC:450, vat20:true,
      noteFR:"4,50‚Ç¨ pi√®ce. Offre: 3 √† 12‚Ç¨.", noteES:"4,50‚Ç¨ unidad. Oferta: 3 por 12‚Ç¨.",
      unitDeals:[{buy:3, payCents:1200, noteFR:"3 pour 12‚Ç¨", noteES:"3 por 12‚Ç¨"}]
    },
    { id:"biere_grande", type:"unit", nameFR:"Bi√®re (grande)", nameES:"Cerveza (grande)", priceC:1200, vat20:true,
      noteFR:"12‚Ç¨ pi√®ce. Offre: les 2 √† 20‚Ç¨.", noteES:"12‚Ç¨ unidad. Oferta: 2 por 20‚Ç¨.",
      unitDeals:[{buy:2, payCents:2000, noteFR:"2 pour 20‚Ç¨", noteES:"2 por 20‚Ç¨"}]
    },
    { id:"tapenade", type:"unit", nameFR:"Tapenade", nameES:"Tapenade", priceC:690, vat20:false,
      noteFR:"6,90‚Ç¨ pi√®ce. Offre: les 3 √† 18‚Ç¨.", noteES:"6,90‚Ç¨ unidad. Oferta: 3 por 18‚Ç¨.",
      unitDeals:[{buy:3, payCents:1800, noteFR:"3 pour 18‚Ç¨", noteES:"3 por 18‚Ç¨"}]
    },
    { id:"terrine", type:"unit", nameFR:"Terrine", nameES:"Terrina", priceC:450, vat20:false,
      noteFR:"4,50‚Ç¨ pi√®ce. Offre: les 3 √† 12‚Ç¨.", noteES:"4,50‚Ç¨ unidad. Oferta: 3 por 12‚Ç¨.",
      unitDeals:[{buy:3, payCents:1200, noteFR:"3 pour 12‚Ç¨", noteES:"3 por 12‚Ç¨"}]
    },
    { id:"miel", type:"unit", nameFR:"Miel (pot)", nameES:"Miel (tarro)", priceC:1200, vat20:false,
      noteFR:"12‚Ç¨ le pot.", noteES:"12‚Ç¨ el tarro." },
    { id:"confiture", type:"unit", nameFR:"Confiture (pot)", nameES:"Mermelada (tarro)", priceC:690, vat20:false,
      noteFR:"6,90‚Ç¨ le pot (BIO).", noteES:"6,90‚Ç¨ el tarro (BIO)." },

    { id:"muscat", type:"unit", nameFR:"Muscat de Rivesaltes", nameES:"Moscatel de Rivesaltes", priceC:1500, vat20:true,
      noteFR:"15‚Ç¨ pi√®ce. Offre: les 2 √† 25‚Ç¨ (mix possible).", noteES:"15‚Ç¨ unidad. Oferta: 2 por 25‚Ç¨.",
      unitDeals:[{buy:2, payCents:2500, noteFR:"2 pour 25‚Ç¨", noteES:"2 por 25‚Ç¨"}]
    },
    { id:"panier", type:"unit", nameFR:"Panier (compter)", nameES:"Cesta", priceC:200, vat20:false,
      noteFR:"Panier compter 2‚Ç¨.", noteES:"Cesta 2‚Ç¨." }
  ];

  function displayName(item){
    return (langNow()==='es' ? item.nameES : item.nameFR) || item.nameFR;
  }
  function displayNote(item){
    return (langNow()==='es' ? item.noteES : item.noteFR) || item.noteFR || '';
  }
  function dealsText(item){
    if(!item.unitDeals || !item.unitDeals.length) return '';
    const d = item.unitDeals[0];
    return langNow()==='es' ? (d.noteES||'') : (d.noteFR||'');
  }

  // ---------------- Money / change ----------------
  const COINS = [200,100,50,20,10,5,2,1];
  const BILLS = [50000,20000,10000,5000,2000,1000,500];
  const DENOMS = [...BILLS, ...COINS];

  function makeBreakdown(amountCents){
    let rest = amountCents;
    const out = [];
    for(const d of DENOMS){
      if(rest<=0) break;
      const k = Math.floor(rest/d);
      if(k>0){ out.push([d,k]); rest-=d*k; }
    }
    return out;
  }
  function breakdownToString(bd){
    if(!bd.length) return '0';
    return bd.map(([d,k]) => d>=100 ? `${k}√ó${(d/100).toFixed(0)}‚Ç¨` : `${k}√ó${d}c`).join(' + ');
  }
  function countCoinsBills(amountCents){
    const bd = makeBreakdown(amountCents);
    let coins=0, bills=0;
    for(const [d,k] of bd){
      if(d>=500) bills+=k;
      else coins+=k;
    }
    return {coins,bills,bd};
  }

  function countingUpSteps(totalCents, paidCents){
    let cur = totalCents;
    const steps = [];
    const push = (to)=>{
      if(to>cur){
        steps.push({from:cur,to,add:to-cur});
        cur=to;
      }
    };
    const mod = cur%100;
    if(mod!==0) push(cur+(100-mod));
    const nice = [5,10,20,50,100,200,500];
    while(cur < paidCents){
      const curEuro = Math.floor(cur/100);
      const candidates = [];
      candidates.push((curEuro+1)*100);
      for(const t of nice){
        const next = (Math.floor(curEuro/t)+1)*t*100;
        candidates.push(next);
      }
      let best = null;
      for(const c of candidates){
        if(c<=paidCents && c>cur) best = best===null ? c : Math.max(best,c);
      }
      if(best===null) best = paidCents;
      push(best);
      if(best===paidCents) break;
    }
    return steps;
  }

  // Smart rounding: ask 1..99 cents to reduce coins or make round euros.
  function suggestRounding(totalCents, paidCents){
    if(paidCents < totalCents) return null;
    const change = paidCents - totalCents;
    const base = countCoinsBills(change);

    const maxAsk = Math.min(99, paidCents-totalCents);
    let best = null;

    for(let ask=1; ask<=maxAsk; ask++){
      const newTotal = totalCents + ask;
      const newChange = paidCents - newTotal;
      const m = countCoinsBills(newChange);

      const score =
        (m.coins * 1000) +
        (newChange % 100 === 0 ? 0 : 200) +
        ask +
        m.bills;

      if(best===null || score < best.score){
        best = {ask, newTotal, newChange, score, base, m};
      }
    }
    if(!best) return null;

    const improvesCoins = best.m.coins < base.coins;
    const improvesRound = (best.newChange%100===0) && (change%100!==0);
    if(!(improvesCoins || improvesRound)) return null;

    return best;
  }

  // ---------------- Deals (unit) ----------------
  function computeUnitLineTotalWithDeals(priceC, qty, deals){
    if(!deals || !deals.length) return {totalC: priceC*qty, dealApplied:null};
    let best = {totalC: priceC*qty, dealApplied:null};
    for(const d of deals){
      const packs = Math.floor(qty / d.buy);
      const rest = qty % d.buy;
      const totalC = packs*d.payCents + rest*priceC;
      if(totalC < best.totalC){
        best = {totalC, dealApplied:{buy:d.buy, payCents:d.payCents, packs, rest, label:(langNow()==='es'?d.noteES:d.noteFR)}};
      }
    }
    return best;
  }

  // ---------------- Training generation (uses catalogue) ----------------
  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function levelConfig(level){
    return {
      level,
      itemsMin: clamp(3+level, 4, 8),
      itemsMax: clamp(6+level*2, 8, 14),
      allowBigBills: level>=4,
      allowMixedPay: level>=3,
      maxTotal: [3500, 6500, 10000, 18000, 28000][clamp(level-1,0,4)]
    };
  }

  function makeTrainingBasket(cfg){
    const n = randInt(cfg.itemsMin, cfg.itemsMax);
    const items = [];

    const pool = [
      ...CATALOG.filter(p=>["gateaux_patis","gateaux_patis_special","gateau_broche","nougat","chocolats","turron"].includes(p.id)).flatMap(x=>Array(3).fill(x)),
      ...CATALOG.filter(p=>["gateaux_esat","tapenade","terrine","confiture","miel","biere_petite","biere_grande"].includes(p.id)).flatMap(x=>Array(4).fill(x)),
      ...CATALOG.filter(p=>["muscat","panier","nougat_cube"].includes(p.id)).flatMap(x=>Array(2).fill(x))
    ];

    for(let i=0;i<n;i++){
      const prod = pick(pool);
      if(prod.type==='weight'){
        let gMin=80, gMax=600;
        if(prod.id.includes("gateau")){ gMin=120; gMax=850; }
        if(prod.id.includes("nougat") || prod.id==="chocolats" || prod.id==="turron"){ gMin=90; gMax=420; }
        const grams = randInt(gMin,gMax);
        const amountC = Math.round(prod.pricePerKgC * grams / 1000);
        items.push({
          type:'weight',
          catalogId: prod.id,
          name: displayName(prod),
          pricePerKgC: prod.pricePerKgC,
          grams,
          amountC,
          vat20: !!prod.vat20,
          note: displayNote(prod)
        });
      } else {
        let qty = randInt(1,3);
        if(prod.unitDeals && Math.random()<0.6){
          qty = prod.unitDeals[0].buy;
          if(Math.random()<0.25) qty += prod.unitDeals[0].buy;
        }
        const unit = computeUnitLineTotalWithDeals(prod.priceC, qty, prod.unitDeals);
        items.push({
          type:'unit',
          catalogId: prod.id,
          name: displayName(prod),
          priceC: prod.priceC,
          qty,
          amountC: unit.totalC,
          vat20: !!prod.vat20,
          dealApplied: unit.dealApplied,
          note: displayNote(prod)
        });
      }
    }

    let total = items.reduce((s,it)=>s+it.amountC,0);

    if(cfg.level<=2){
      total = total - (total%5);
    } else if(cfg.level===3){
      const c = total%100;
      if([1,2,3,4].includes(c)) total += (5-c);
      if([6,7,8,9].includes(c)) total += (10-c);
    }

    if(total > cfg.maxTotal){
      const factor = cfg.maxTotal / total;
      total = Math.max(300, Math.floor(total*factor));
      total = total - (total % 5);
    }

    return {items, totalCents: total};
  }

  function generatePayment(totalCents, cfg){
    const options = [];
    options.push(Math.ceil(totalCents/100)*100);
    for(const step of [500, 1000, 2000, 5000, 10000]){
      options.push(Math.ceil(totalCents/step)*step);
    }
    if(cfg.allowBigBills){
      options.push(10000); options.push(20000);
    }
    if(cfg.level>=3 && Math.random()<0.10) options.push(totalCents);

    let paid = pick(options.filter(x=>x>=totalCents));

    if(cfg.level>=4 && Math.random()<0.18){
      const extra = pick([10,20,50,100,200]);
      paid += extra;
    }

    let breakdown = [paid];
    if(cfg.allowMixedPay && Math.random()<0.65){
      breakdown = makeBreakdown(paid).flatMap(([d,k])=>Array(k).fill(d));
      breakdown.sort(()=>Math.random()-0.5);
    }
    return {paidCents: paid, breakdown};
  }

  function basketToText(items, totalCents){
    const lines = items.map(it=>{
      if(it.type==='weight'){
        const p = (it.pricePerKgC/100).toFixed(2).replace('.', ',');
        return `‚Ä¢ ${it.name} (${it.grams} g √† ${p} ‚Ç¨/kg) = ${euroText(it.amountC)}`;
      } else {
        const p = (it.priceC/100).toFixed(2).replace('.', ',');
        const promo = it.dealApplied ? ` ¬∑ promo: ${it.dealApplied.label}` : '';
        return `‚Ä¢ ${it.name} (${it.qty} √ó ${p} ‚Ç¨) = ${euroText(it.amountC)}${promo}`;
      }
    });
    lines.push(`\nTOTAL = ${euroText(totalCents)}`);
    return lines.join('\n');
  }

  // ---------------- App state / stats ----------------
  const LS_KEY_STATS = 'payecash_stats_v4';
  const LS_KEY_CHECK = 'payecash_check_v1';

  const state = {
    mode: 'training',
    level: 3,
    showHints: true,
    showDetails: false,
    startTime: null,
    timerInt: null,
    trainingCase: null,
    stats: null,
    tillItems: [],
    tillSubmode: 'catalog', // catalog | simple
    simpleList: []
  };

  function loadStats(){
    const raw = localStorage.getItem(LS_KEY_STATS);
    if(raw){ try { return JSON.parse(raw); } catch(e){} }
    return { solved:0, correct:0, mistakes:0, streak:0, bestStreak:0, timesMs:[] };
  }
  function saveStats(){ localStorage.setItem(LS_KEY_STATS, JSON.stringify(state.stats)); }

  function renderStats(){
    const s = state.stats;
    el('solved').textContent = s.solved.toString();
    el('mistakes').textContent = s.mistakes.toString();
    el('streak').textContent = s.streak.toString();
    const acc = s.solved ? Math.round((s.correct/s.solved)*100) : 0;
    el('acc').textContent = `${acc}%`;
    if(s.timesMs.length){
      const avg = Math.round(s.timesMs.reduce((a,b)=>a+b,0)/s.timesMs.length);
      el('avgTime').textContent = `${(avg/1000).toFixed(1)}s`;
    } else el('avgTime').textContent='--';
  }

  // ---------------- Timer ----------------
  function startTimer(){
    if(state.timerInt) clearInterval(state.timerInt);
    const tick = ()=>{
      if(!state.startTime) return;
      const ms = now()-state.startTime;
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const ss = (s%60).toString().padStart(2,'0');
      el('timer').textContent = `${m.toString().padStart(2,'0')}:${ss}`;
    };
    tick();
    state.timerInt=setInterval(tick,250);
  }

  // ---------------- Mode switching ----------------
  function setMode(mode){
    state.mode = mode;

    el('trainingPanel').style.display = (mode==='training') ? 'block' : 'none';
    el('tillPanel').style.display = (mode==='till') ? 'block' : 'none';
    el('checklistPanel').style.display = (mode==='checklist') ? 'block' : 'none';

    el('tabTraining').classList.toggle('active', mode==='training');
    el('tabTill').classList.toggle('active', mode==='till');
    el('tabChecklist').classList.toggle('active', mode==='checklist');

    el('tabTraining').setAttribute('aria-selected', mode==='training' ? 'true' : 'false');
    el('tabTill').setAttribute('aria-selected', mode==='till' ? 'true' : 'false');
    el('tabChecklist').setAttribute('aria-selected', mode==='checklist' ? 'true' : 'false');

    el('mainTitle').textContent =
      mode==='training' ? 'Entra√Ænement r√©aliste' :
      mode==='till' ? 'Vraie caisse' :
      'Checklist';
  }

  function setTillSubmode(sub){
    state.tillSubmode = sub;
    const isCatalog = sub==='catalog';

    el('subCatalog').classList.toggle('active', isCatalog);
    el('subSimple').classList.toggle('active', !isCatalog);
    el('subCatalog').setAttribute('aria-selected', isCatalog ? 'true' : 'false');
    el('subSimple').setAttribute('aria-selected', !isCatalog ? 'true' : 'false');

    el('catalogSubPanel').style.display = isCatalog ? 'block' : 'none';
    el('simpleSubPanel').style.display = isCatalog ? 'none' : 'block';

    if(!isCatalog){
      updateSimpleCashier();
    } else {
      updateTillSummary();
    }
  }

  // ---------------- Training UI ----------------
  function setFeedback(obj){
    const fb = el('feedback');
    if(!obj){
      fb.style.display='none';
      fb.textContent='';
      fb.className='result';
      return;
    }
    fb.style.display='block';
    fb.textContent=obj.text;
    fb.className='result ' + (obj.kind||'');
  }

  function renderTrainingCase(){
    const c = state.trainingCase;
    if(!c) return;

    el('totalDisplay').textContent = euroText(c.totalCents);
    el('paidDisplay').textContent = euroText(c.paidCents);
    el('paidBreakdown').textContent = `Client: ${breakdownToString(makeBreakdown(c.paidCents))} (ou combo)`;
    el('caseMeta').textContent = `Panier: ${c.items.length} article(s) ¬∑ Catalogue magasin`;

    el('detailsBlock').textContent = basketToText(c.items, c.totalCents);
    el('detailsBlock').style.display = state.showDetails ? 'block' : 'none';

    const steps = countingUpSteps(c.totalCents, c.paidCents)
      .map(s=>`- ${euroText(s.from)} ‚Üí ${euroText(s.to)} : +${euroText(s.add)}`).join('\n');

    const change = c.paidCents - c.totalCents;
    const sug = suggestRounding(c.totalCents, c.paidCents);

    let hint = `Aide ‚Äúcompl√©ter jusqu‚Äô√†‚Äù\n${steps || '(exact, rien √† rendre)'}\n\nMonnaie: ${euroText(change)}\nBillets/pi√®ces: ${breakdownToString(makeBreakdown(change))}`;
    if(sug){
      hint += `\n\nArrondi utile: demander ${euroText(sug.ask)} ‚Üí monnaie devient ${euroText(sug.newChange)}\n(${breakdownToString(makeBreakdown(sug.newChange))})`;
    } else {
      hint += `\n\nArrondi: pas utile ici.`;
    }
    el('hintBlock').textContent = hint;
    el('hintBlock').style.display = state.showHints ? 'block' : 'none';

    const L = PHRASES[langNow()] || PHRASES.fr;
    const qp = el('quickPhrases');
    qp.innerHTML='';
    const chips=[];
    chips.push(`${L.greet} ¬∑ ${L.pay}`);

    if(sug){
      const x = centsToInput(sug.ask);
      const promised = (sug.newChange%100===0) ? String(Math.floor(sug.newChange/100)) : centsToInput(sug.newChange);
      chips.push(L.roundingAsk(x));
      chips.push(L.roundingAsk2(x, promised));
    } else {
      chips.push(L.exact(centsToInput(change)));
    }
    chips.push(L.thanks);

    for(const t of chips){
      const d=document.createElement('div');
      d.className='chip';
      d.textContent=t;
      d.addEventListener('click', ()=>{
        if(sug){
          el('askInput').value = centsToInput(sug.ask);
        }
      });
      qp.appendChild(d);
    }

    el('levelLabel').textContent = state.level.toString();
    renderStats();
  }

  function newTrainingCase(){
    const cfg = levelConfig(state.level);
    const basket = makeTrainingBasket(cfg);
    const pay = generatePayment(basket.totalCents, cfg);

    state.trainingCase = {
      items: basket.items,
      totalCents: basket.totalCents,
      paidCents: pay.paidCents,
      breakdown: pay.breakdown
    };

    state.startTime = now();
    el('answerInput').value='';
    el('askInput').value='';
    setFeedback(null);
    renderTrainingCase();
    el('answerInput').focus();
  }

  function checkTraining({showCorrection=false, panic=false}={}){
    const c = state.trainingCase;
    if(!c) return;

    const ans = parseEurosToCents(el('answerInput').value);
    const ask = parseEurosToCents(el('askInput').value);

    if(ans===null){
      setFeedback({kind:'warn', text:'Entre une monnaie √† rendre valide (ex: 18,25).'});
      return;
    }

    const roundingMode = el('roundingMode').value;
    const baseChange = c.paidCents - c.totalCents;
    const sug = suggestRounding(c.totalCents, c.paidCents);

    let expectedChange = baseChange;
    let expectedAsk = null;

    const userProposes = ask!==null && ask>0;

    if(roundingMode==='off'){
      expectedChange = baseChange;
    } else if(roundingMode==='must'){
      if(sug){
        expectedAsk = sug.ask;
        expectedChange = sug.newChange;
      }
    } else {
      if(userProposes && c.totalCents + ask <= c.paidCents){
        const newChange = c.paidCents - (c.totalCents + ask);
        const base = countCoinsBills(baseChange);
        const m = countCoinsBills(newChange);
        const improvesCoins = m.coins < base.coins;
        const improvesRound = (newChange%100===0) && (baseChange%100!==0);
        if(improvesCoins || improvesRound){
          expectedAsk = ask;
          expectedChange = newChange;
        }
      }
    }

    const okChange = ans === expectedChange;
    const okAsk = expectedAsk===null ? !(roundingMode==='must' && sug) : (ask===expectedAsk);
    const ok = okChange && okAsk;

    const t = now()-state.startTime;

    if(showCorrection || panic){
      const steps = countingUpSteps(c.totalCents, c.paidCents)
        .map(s=>`‚Ä¢ ${euroText(s.from)} ‚Üí ${euroText(s.to)} : +${euroText(s.add)}`).join('\n');
      let txt = `Correction (compl√©ter):\n${steps || '‚Ä¢ Exact: rien √† rendre'}\n\nSans arrondi: ${euroText(baseChange)} (${breakdownToString(makeBreakdown(baseChange))})`;
      if(sug){
        txt += `\n\nArrondi conseill√©: demander ${euroText(sug.ask)} ‚Üí rendre ${euroText(sug.newChange)} (${breakdownToString(makeBreakdown(sug.newChange))})`;
      }
      setFeedback({kind: panic?'warn':'good', text:txt});
      return;
    }

    state.stats.solved += 1;
    if(ok){
      state.stats.correct += 1;
      state.stats.streak += 1;
      state.stats.bestStreak = Math.max(state.stats.bestStreak, state.stats.streak);
      state.stats.timesMs.push(t);
      saveStats();
      renderStats();
      setFeedback({kind:'good', text:`‚úÖ Juste. Temps: ${(t/1000).toFixed(1)}s\nProchain client‚Ä¶`});
      setTimeout(newTrainingCase, 350);
    } else {
      state.stats.mistakes += 1;
      state.stats.streak = 0;
      saveStats();
      renderStats();
      let msg = `‚ùå Pas bon.\nAttendu: ${euroText(expectedChange)}.\n`;
      if(roundingMode==='must' && sug){
        msg += `Arrondi attendu: demander ${euroText(sug.ask)}.\n`;
      }
      msg += `Clique ‚ÄúVoir correction‚Äù pour les marches.`;
      setFeedback({kind:'bad', text:msg});
    }
  }

  // ---------------- Till mode (catalog) ----------------
  function makeRow(item, idx){
    const tr = document.createElement('tr');

    const tdType = document.createElement('td');
    const sel = document.createElement('select');
    sel.innerHTML = `
      <option value="unit"${item.type==='unit'?' selected':''}>Unit√©</option>
      <option value="weight"${item.type==='weight'?' selected':''}>Poids</option>
      <option value="direct"${item.type==='direct'?' selected':''}>Montant</option>
    `;
    sel.addEventListener('change', ()=>{
      item.type = sel.value;
      if(item.type==='unit'){ item.priceC = item.priceC ?? 0; item.qty = item.qty ?? 1; item.unitDeals = item.unitDeals ?? null; }
      if(item.type==='weight'){ item.pricePerKgC = item.pricePerKgC ?? 0; item.grams = item.grams ?? 0; }
      if(item.type==='direct'){ item.amountC = item.amountC ?? 0; }
      renderTill();
    });
    tdType.appendChild(sel);

    const tdLabel = document.createElement('td');
    const inpLabel = document.createElement('input');
    inpLabel.placeholder = 'Libell√©';
    inpLabel.value = item.label || '';
    inpLabel.addEventListener('input', ()=>{ item.label = inpLabel.value; });
    tdLabel.appendChild(inpLabel);

    const tdPrice = document.createElement('td');
    tdPrice.className='cell-mini';
    const inpPrice = document.createElement('input');
    inpPrice.inputMode='decimal';

    const tdQty = document.createElement('td');
    tdQty.className='cell-mini';
    const inpQty = document.createElement('input');
    inpQty.inputMode='decimal';

    const tdLine = document.createElement('td');
    tdLine.className='cell-mid';
    const lineSpan = document.createElement('span');
    lineSpan.className='mono';
    tdLine.appendChild(lineSpan);

    function updateInputs(){
      if(item.type==='unit'){
        inpPrice.placeholder='Prix unit√© (‚Ç¨)';
        inpPrice.value = item.priceC!=null ? centsToInput(item.priceC) : '';
        inpQty.placeholder='Qt√©';
        inpQty.value = item.qty!=null ? String(item.qty) : '1';
      } else if(item.type==='weight'){
        inpPrice.placeholder='Prix/kg (‚Ç¨)';
        inpPrice.value = item.pricePerKgC!=null ? centsToInput(item.pricePerKgC) : '';
        inpQty.placeholder='Grammes';
        inpQty.value = item.grams!=null ? String(item.grams) : '';
      } else {
        inpPrice.placeholder='Montant (‚Ç¨)';
        inpPrice.value = item.amountC!=null ? centsToInput(item.amountC) : '';
        inpQty.placeholder='‚Äî';
        inpQty.value = '';
      }
    }

    inpPrice.addEventListener('input', ()=>{
      const v = parseEurosToCents(inpPrice.value);
      if(item.type==='unit'){ item.priceC = v ?? 0; }
      else if(item.type==='weight'){ item.pricePerKgC = v ?? 0; }
      else { item.amountC = v ?? 0; }
      renderTillTotalsOnly();
    });

    inpQty.addEventListener('input', ()=>{
      if(item.type==='unit'){
        const q = parseInt(inpQty.value,10);
        item.qty = Number.isFinite(q) && q>0 ? q : 1;
      } else if(item.type==='weight'){
        const g = parseInt(inpQty.value,10);
        item.grams = Number.isFinite(g) && g>=0 ? g : 0;
      }
      renderTillTotalsOnly();
    });

    tdPrice.appendChild(inpPrice);
    tdQty.appendChild(inpQty);

    const tdAct = document.createElement('td');
    tdAct.className='cell-actions';
    const del = document.createElement('button');
    del.className='btn small danger';
    del.textContent='Suppr.';
    del.addEventListener('click', ()=>{
      state.tillItems.splice(idx,1);
      renderTill();
    });
    tdAct.appendChild(del);

    tr.appendChild(tdType);
    tr.appendChild(tdLabel);
    tr.appendChild(tdPrice);
    tr.appendChild(tdQty);
    tr.appendChild(tdLine);
    tr.appendChild(tdAct);

    function lineTotalCents(){
      if(item.type==='unit'){
        const price = item.priceC ?? 0;
        const qty = item.qty ?? 1;
        const r = computeUnitLineTotalWithDeals(price, qty, item.unitDeals);
        tr._dealLabel = r.dealApplied?.label || null;
        return r.totalC;
      }
      if(item.type==='weight'){
        const pk = item.pricePerKgC ?? 0;
        const g = item.grams ?? 0;
        tr._dealLabel = null;
        return Math.round(pk * g / 1000);
      }
      tr._dealLabel = null;
      return item.amountC ?? 0;
    }

    function refreshLine(){
      updateInputs();
      const lt = lineTotalCents();
      if(tr._dealLabel){
        lineSpan.textContent = `${euroText(lt)} (promo: ${tr._dealLabel})`;
      } else {
        lineSpan.textContent = euroText(lt);
      }
    }

    tr._refreshLine = refreshLine;
    tr._lineTotalCents = lineTotalCents;
    refreshLine();
    return tr;
  }

  function tillTotalCents(){
    let sum=0;
    const tbody = el('itemsBody');
    for(const tr of Array.from(tbody.children)){
      if(typeof tr._lineTotalCents==='function') sum += tr._lineTotalCents();
    }
    return sum;
  }

  function renderPhraseChips(container, texts, appointToCopyCents){
    container.innerHTML='';
    for(const t of texts){
      const d=document.createElement('div');
      d.className='chip';
      d.textContent=t;
      d.addEventListener('click', ()=>{
        if(appointToCopyCents!=null){
          navigator.clipboard?.writeText(centsToInput(appointToCopyCents));
        }
      });
      container.appendChild(d);
    }
  }

  function updateTillSummary(){
    const total = tillTotalCents();
    const paid = parseEurosToCents(el('tillPaidInput').value) ?? 0;

    el('tillTotal').textContent = euroText(total);
    el('tillTotal2').textContent = euroText(total);
    el('tillPaid2').textContent = euroText(paid);

    if(paid < total){
      el('tillChange').textContent = '‚Äî';
      el('tillWarn').textContent = `Paiement insuffisant: il manque ${euroText(total-paid)}.`;
      el('tillWarn').style.color = 'var(--warn)';
      el('tillSuggestionText').textContent = 'Paiement insuffisant, pas de suggestion.';
      el('tillPhrases').innerHTML='';
      return;
    }

    const change = paid - total;
    el('tillChange').textContent = euroText(change);
    el('tillWarn').textContent = `Billets/pi√®ces: ${breakdownToString(makeBreakdown(change))}`;
    el('tillWarn').style.color = 'var(--muted)';

    const sug = suggestRounding(total, paid);
    const L = PHRASES[langNow()] || PHRASES.fr;

    if(!sug){
      el('tillSuggestionText').textContent = `Pas d‚Äôarrondi utile ici. (Monnaie: ${euroText(change)})`;
      renderPhraseChips(el('tillPhrases'), [
        `${L.greet} ¬∑ ${L.pay}`,
        L.exact(centsToInput(change)),
        L.thanks
      ], null);
      return;
    }

    const askTxt = centsToInput(sug.ask);
    const promised = (sug.newChange%100===0) ? String(Math.floor(sug.newChange/100)) : centsToInput(sug.newChange);

    const base = countCoinsBills(change);
    const after = countCoinsBills(sug.newChange);

    el('tillSuggestionText').textContent =
      `Demander ${euroText(sug.ask)} ‚Üí monnaie devient ${euroText(sug.newChange)}.\n`+
      `Pi√®ces: ${base.coins} ‚Üí ${after.coins} (objectif: moins de pi√®ces).`;

    renderPhraseChips(el('tillPhrases'), [
      `${L.greet} ¬∑ ${L.pay}`,
      L.roundingAsk(askTxt),
      L.roundingAsk2(askTxt, promised),
      L.thanks
    ], sug.ask);
  }

  function renderTillTotalsOnly(){
    const tbody = el('itemsBody');
    for(const tr of Array.from(tbody.children)){
      if(tr._refreshLine) tr._refreshLine();
    }
    updateTillSummary();
  }

  function renderTill(){
    const tbody = el('itemsBody');
    tbody.innerHTML='';
    state.tillItems.forEach((it, idx)=>{
      const tr = makeRow(it, idx);
      tbody.appendChild(tr);
    });
    renderTillTotalsOnly();
  }

  function addTillItem(type){
    if(type==='unit'){
      state.tillItems.push({type:'unit', label:'', priceC:0, qty:1, unitDeals:null});
    } else if(type==='weight'){
      state.tillItems.push({type:'weight', label:'', pricePerKgC:0, grams:0});
    } else {
      state.tillItems.push({type:'direct', label:'', amountC:0});
    }
    renderTill();
  }

  // ---------------- Catalogue UI ----------------
  function refreshCatalogSelect(filterText=''){
    const s = el('catalogSelect');
    s.innerHTML='';

    const ft = (filterText||'').trim().toLowerCase();
    const list = CATALOG
      .filter(p=>{
        const name = (p.nameFR + ' ' + (p.nameES||'') + ' ' + (p.noteFR||'')).toLowerCase();
        return ft ? name.includes(ft) : true;
      })
      .sort((a,b)=> (displayName(a)).localeCompare(displayName(b), 'fr'));

    for(const p of list){
      const opt = document.createElement('option');
      opt.value = p.id;
      const priceTxt = p.type==='weight' ? `${centsToInput(p.pricePerKgC)}‚Ç¨/kg` : `${centsToInput(p.priceC)}‚Ç¨`;
      opt.textContent = `${displayName(p)} ¬∑ ${priceTxt}${p.vat20?' ¬∑ TVA20':''}${dealsText(p)?' ¬∑ '+dealsText(p):''}`;
      s.appendChild(opt);
    }
    if(list.length){
      s.value = list[0].id;
      renderCatalogInfo();
    } else {
      el('catalogInfo').textContent = 'Aucun produit trouv√©.';
    }
  }

  function getSelectedProduct(){
    const id = el('catalogSelect').value;
    return CATALOG.find(p=>p.id===id) || null;
  }

  function renderCatalogInfo(){
    const p = getSelectedProduct();
    if(!p){ el('catalogInfo').textContent='‚Äî'; return; }

    const name = displayName(p);
    const note = displayNote(p);
    const deals = dealsText(p);
    const priceLine = p.type==='weight'
      ? `Prix: ${centsToInput(p.pricePerKgC)} ‚Ç¨/kg`
      : `Prix: ${centsToInput(p.priceC)} ‚Ç¨ / pi√®ce`;
    const vat = p.vat20 ? 'TVA 20% (alcool/nougat)' : 'TVA 20%: non (note)';
    el('catalogInfo').textContent =
      `${name}\n${priceLine}\n${deals ? ('Promo: '+deals+'\n') : ''}${vat}\n\n${note || ''}`.trim();

    if(p.type==='weight'){
      el('catalogGrams').disabled = false;
      el('catalogQty').disabled = true;
      el('catalogQty').value = '';
      el('dealHint').textContent = deals ? `Promo dispo: ${deals}` : 'Produit au poids.';
    } else {
      el('catalogGrams').disabled = true;
      el('catalogQty').disabled = false;
      el('catalogGrams').value = '';
      el('dealHint').textContent = deals ? `Astuce: promo possible (${deals}).` : 'Produit √† l‚Äôunit√©.';
    }
    el('applyDeal').disabled = !(p.unitDeals && p.unitDeals.length && p.type==='unit');
  }

  function addFromCatalog(applyPromo=false){
    const p = getSelectedProduct();
    if(!p) return;

    if(p.type==='weight'){
      const grams = parseInt(el('catalogGrams').value,10);
      const g = Number.isFinite(grams) && grams>0 ? grams : 200;
      state.tillItems.push({
        type:'weight',
        label: displayName(p),
        pricePerKgC: p.pricePerKgC,
        grams: g
      });
    } else {
      const qtyRaw = parseInt(el('catalogQty').value,10);
      const qty = Number.isFinite(qtyRaw) && qtyRaw>0 ? qtyRaw : 1;
      state.tillItems.push({
        type:'unit',
        label: displayName(p),
        priceC: p.priceC,
        qty,
        unitDeals: applyPromo ? (p.unitDeals||null) : null
      });
    }
    renderTill();
  }

  // ---------------- Simple cashier ----------------
  function renderSimpleList(){
    const list = state.simpleList;
    const lines = list.map((c,i)=> `${i+1}. ${euroText(c)}`).join('\n');
    el('simpleList').textContent = ifEmpty(lines, 'Aucun montant ajout√©.');
    const sum = list.reduce((a,b)=>a+b,0);
    el('simpleListSum').textContent = euroText(sum);

    // If user wants, auto-fill total with list sum when total is empty
    const currentTotal = parseEurosToCents(el('simpleTotalInput').value);
    if((currentTotal===null || currentTotal===0) && sum>0){
      el('simpleTotalInput').value = centsToInput(sum);
    }
  }

  function ifEmpty(str, fallback){ return (str && str.trim().length) ? str : fallback; }

  function updateSimpleCashier(){
    const totalC = parseEurosToCents(el('simpleTotalInput').value) ?? 0;
    const paidC = parseEurosToCents(el('simplePaidInput').value) ?? 0;

    const L = PHRASES[langNow()] || PHRASES.fr;
    el('simplePhrases').innerHTML = '';

    if(totalC<=0){
      el('simpleChange').textContent = '‚Äî';
      el('simpleSuggestionText').textContent = 'Renseigne un Total (ou ajoute des montants).';
      return;
    }
    if(paidC<=0){
      el('simpleChange').textContent = '‚Äî';
      el('simpleSuggestionText').textContent = 'Renseigne le Pay√© du client.';
      return;
    }
    if(paidC < totalC){
      el('simpleChange').textContent = '‚Äî';
      el('simpleSuggestionText').textContent = `Paiement insuffisant: il manque ${euroText(totalC-paidC)}.`;
      renderPhraseChips(el('simplePhrases'), [`${L.greet} ¬∑ ${L.pay}`], null);
      return;
    }

    const change = paidC - totalC;
    el('simpleChange').textContent = euroText(change);

    const sug = suggestRounding(totalC, paidC);
    if(!sug){
      el('simpleSuggestionText').textContent =
        `Monnaie: ${euroText(change)}\nBillets/pi√®ces: ${breakdownToString(makeBreakdown(change))}\nArrondi: pas utile.`;
      renderPhraseChips(el('simplePhrases'), [
        `${L.greet} ¬∑ ${L.pay}`,
        L.exact(centsToInput(change)),
        L.thanks
      ], null);
      return;
    }

    const askTxt = centsToInput(sug.ask);
    const promised = (sug.newChange%100===0) ? String(Math.floor(sug.newChange/100)) : centsToInput(sug.newChange);

    el('simpleSuggestionText').textContent =
      `Monnaie: ${euroText(change)} (${breakdownToString(makeBreakdown(change))})\n`+
      `Arrondi conseill√©: demander ${euroText(sug.ask)} ‚Üí rendre ${euroText(sug.newChange)}\n`+
      `(${breakdownToString(makeBreakdown(sug.newChange))})`;

    renderPhraseChips(el('simplePhrases'), [
      `${L.greet} ¬∑ ${L.pay}`,
      L.roundingAsk(askTxt),
      L.roundingAsk2(askTxt, promised),
      L.thanks
    ], sug.ask);
  }

  // ---------------- Checklist ----------------
  const CHECK_OPEN = [
    {id:"facing", text:"Facing du magasin r√©guli√®rement, charger le magasin (pas de trous)."},
    {id:"notes_produits", text:"Relire notes produits si besoin."},
    {id:"heures", text:"Noter ses heures quotidiennement."},
    {id:"demander_appoint", text:"Demander r√©guli√®rement la monnaie / l‚Äôappoint au client."},
    {id:"menage", text:"M√©nage r√©guli√®rement."}
  ];
  const CHECK_CLOSE = [
    {id:"tpe_cb", text:"TPE le soir: CB telecollect √† faire."},
    {id:"cb_totaux", text:"Montant CB sur appareil = mes totaux."},
    {id:"clim", text:"√âteindre la clim le soir."},
    {id:"papier_tpe", text:"Changer rouleau de TPE quand papier rose."},
    {id:"truc_mythe", text:"Penser important au ‚Äòtruc √† mythe‚Äô le soir."},
    {id:"poubelle", text:"Sortir poubelle lundi soir et la rentrer mardi matin."},
    {id:"cle_caisse", text:"Ranger la cl√© de la caisse sous une bouteille de vin."},
    {id:"enveloppe", text:"Enveloppe du soir: date en haut, SPN au milieu, CA en bas."}
  ];

  function loadCheckState(){
    const raw = localStorage.getItem(LS_KEY_CHECK);
    if(raw){ try { return JSON.parse(raw); } catch(e){} }
    return {};
  }
  function saveCheckState(obj){
    localStorage.setItem(LS_KEY_CHECK, JSON.stringify(obj));
  }

  function renderChecklist(){
    const st = loadCheckState();

    const open = el('checklistOpen');
    const close = el('checklistClose');
    open.innerHTML = '<div class="muted" style="margin-bottom:8px">Ouverture / journ√©e</div>';
    close.innerHTML = '<div class="muted" style="margin-bottom:8px">Fermeture / soir</div>';

    const mk = (item)=>{
      const wrap = document.createElement('label');
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.checked = !!st[item.id];
      cb.addEventListener('change', ()=>{
        const s2 = loadCheckState();
        s2[item.id] = cb.checked;
        saveCheckState(s2);
      });
      const txt = document.createElement('div');
      txt.textContent = item.text;
      wrap.appendChild(cb);
      wrap.appendChild(txt);
      return wrap;
    };

    for(const it of CHECK_OPEN) open.appendChild(mk(it));
    for(const it of CHECK_CLOSE) close.appendChild(mk(it));
  }

  function setAllChecks(value){
    const st = loadCheckState();
    [...CHECK_OPEN, ...CHECK_CLOSE].forEach(it=> st[it.id]=value);
    saveCheckState(st);
    renderChecklist();
  }

  // ---------------- Events ----------------
  el('tabTraining').addEventListener('click', ()=>setMode('training'));
  el('tabTill').addEventListener('click', ()=>{
    setMode('till');
    setTillSubmode(state.tillSubmode);
  });
  el('tabChecklist').addEventListener('click', ()=>{
    setMode('checklist');
    renderChecklist();
  });

  el('subCatalog').addEventListener('click', ()=>setTillSubmode('catalog'));
  el('subSimple').addEventListener('click', ()=>setTillSubmode('simple'));

  el('newCase').addEventListener('click', ()=> { if(state.mode==='training') newTrainingCase(); });

  el('toggleHints').addEventListener('click', ()=>{
    state.showHints = !state.showHints;
    el('toggleHints').textContent = state.showHints ? 'Aide ON' : 'Aide OFF';
    if(state.mode==='training') renderTrainingCase();
  });
  el('toggleDetails').addEventListener('click', ()=>{
    state.showDetails = !state.showDetails;
    el('toggleDetails').textContent = state.showDetails ? 'Afficher d√©tails' : 'Masquer d√©tails';
    if(state.mode==='training') renderTrainingCase();
  });

  el('check').addEventListener('click', ()=>checkTraining());
  el('showSolution').addEventListener('click', ()=>checkTraining({showCorrection:true}));
  el('panic').addEventListener('click', ()=>checkTraining({panic:true}));

  el('levelUp').addEventListener('click', ()=>{
    state.level = clamp(state.level+1, 1, 5);
    el('levelLabel').textContent = state.level.toString();
    if(state.mode==='training') newTrainingCase();
  });
  el('levelDown').addEventListener('click', ()=>{
    state.level = clamp(state.level-1, 1, 5);
    el('levelLabel').textContent = state.level.toString();
    if(state.mode==='training') newTrainingCase();
  });

  el('customerLang').addEventListener('change', ()=>{
    refreshCatalogSelect(el('catalogSearch').value);
    if(state.mode==='training') newTrainingCase();
    renderCatalogInfo();
    updateTillSummary();
    updateSimpleCashier();
  });

  el('resetStats').addEventListener('click', ()=>{
    if(confirm('R√©initialiser les statistiques locales ?')){
      localStorage.removeItem(LS_KEY_STATS);
      state.stats = loadStats();
      renderStats();
      setFeedback({kind:'warn', text:'Stats r√©initialis√©es.'});
    }
  });

  el('exportStats').addEventListener('click', ()=>{
    const data = JSON.stringify({level: state.level, stats: state.stats}, null, 2);
    navigator.clipboard?.writeText(data).then(()=> alert('Stats copi√©es (JSON).')).catch(()=>console.log(data));
  });

  // Till controls
  el('addUnit').addEventListener('click', ()=>addTillItem('unit'));
  el('addWeight').addEventListener('click', ()=>addTillItem('weight'));
  el('addDirect').addEventListener('click', ()=>addTillItem('direct'));
  el('clearItems').addEventListener('click', ()=>{
    if(confirm('Supprimer toutes les lignes ?')){
      state.tillItems = [];
      renderTill();
    }
  });
  el('tillPaidInput').addEventListener('input', ()=>updateTillSummary());

  // Catalogue controls
  el('catalogSearch').addEventListener('input', ()=> refreshCatalogSelect(el('catalogSearch').value));
  el('catalogSelect').addEventListener('change', ()=> renderCatalogInfo());
  el('catalogAdd').addEventListener('click', ()=> addFromCatalog(false));
  el('applyDeal').addEventListener('click', ()=> addFromCatalog(true));

  // Simple cashier controls
  el('simpleTotalInput').addEventListener('input', ()=>updateSimpleCashier());
  el('simplePaidInput').addEventListener('input', ()=>updateSimpleCashier());
  el('simpleCompute').addEventListener('click', ()=>updateSimpleCashier());
  el('simpleClear').addEventListener('click', ()=>{
    el('simpleTotalInput').value='';
    el('simplePaidInput').value='';
    el('simpleChange').textContent='‚Äî';
    el('simpleSuggestionText').textContent='Renseigne Total + Pay√©, puis ‚ÄúCalculer‚Äù.';
    el('simplePhrases').innerHTML='';
  });

  el('simpleAddBtn').addEventListener('click', ()=>{
    const c = parseEurosToCents(el('simpleAddAmount').value);
    if(c===null){
      el('simpleAddAmount').focus();
      return;
    }
    state.simpleList.push(c);
    el('simpleAddAmount').value='';
    renderSimpleList();
    updateSimpleCashier();
  });

  el('simpleListClear').addEventListener('click', ()=>{
    state.simpleList = [];
    renderSimpleList();
    updateSimpleCashier();
  });

  // Checklist controls
  el('checkAll').addEventListener('click', ()=> setAllChecks(true));
  el('uncheckAll').addEventListener('click', ()=> setAllChecks(false));

  // keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && state.mode==='training'){
      const tag = (document.activeElement?.tagName || '').toLowerCase();
      if(tag!=='select') checkTraining();
    }
    if(e.key.toLowerCase()==='n' && state.mode==='training') newTrainingCase();
    if(e.key.toLowerCase()==='h' && state.mode==='training'){
      state.showHints = !state.showHints;
      el('toggleHints').textContent = state.showHints ? 'Aide ON' : 'Aide OFF';
      renderTrainingCase();
    }
  });

  // ---------------- Boot ----------------
  function refreshCatalogInfoDefaults(){
    // enable/disable initial
    el('catalogGrams').disabled = true;
    el('catalogQty').disabled = false;
    el('applyDeal').disabled = true;
  }

  function boot(){
    state.stats = loadStats();
    renderStats();
    startTimer();

    setMode('training');

    refreshCatalogInfoDefaults();
    refreshCatalogSelect('');
    renderCatalogInfo();

    addTillItem('unit');
    renderSimpleList();

    setTillSubmode('catalog');
    newTrainingCase();
  }

  boot();
})();
</script>
</body>
</html>
